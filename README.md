# SMB2 Packet Extractor

## Overview
This project provides a set of Python scripts to extract and process SMB2 (Server Message Block version 2) packet data from a pcap (packet capture) file. The main functionality includes converting the pcap file to JSON format and extracting attachments from SMB2 WRITE and SMB2 READ commands, saving them to a specified directory along with their metadata.

## Directory Structure
```
SMB2-Packet-Extractor/
├── main.py
├── pcap_to_json.py
├── extract_attachments.py
├── utils.py
├── outputs/ (created by the script)
│   ├── attachment_<MID>_<Command>.bin
├── pcap_data.json (generated by the script)
└── metadata.json (generated by the script)
```

## Files
- **main.py**: The main script that orchestrates the entire process.
- **pcap_to_json.py**: Converts the pcap file to a JSON file containing packet details.
- **extract_attachments.py**: Extracts attachments from the JSON file and saves metadata.
- **utils.py**: Contains utility functions used in the extraction process.
- **outputs/**: Directory where extracted attachments are saved.

## Requirements
- Python 3.x
- `scapy` library
- `json` library (comes with Python)
- `base64` library (comes with Python)
- `datetime` library (comes with Python)
- `sys` library (comes with Python)
- `os` library (comes with Python)

## Installation
1. Clone the repository:
    ```sh
    git clone <repository-url>
    cd SOC-Packet-analyst/smb_extractor/
    ```

2. Install the required libraries:
    ```sh
    pip install scapy
    ```

## Usage
1. Place your pcap file in the same directory as the scripts.

2. Run the main script with the pcap file as an argument:
    ```sh
    python3 main.py <pcap_file>
    ```

3. The script will generate:
    - `pcap_data.json`: A JSON file containing detailed information about each packet.
    - `outputs/`: A directory containing the extracted attachments.
    - `metadata.json`: A JSON file containing metadata about the extracted attachments.

## Detailed Description

### `main.py`
Coordinates the entire process by calling functions from `pcap_to_json.py` and `extract_attachments.py`.

### `pcap_to_json.py`
Converts the pcap file to a JSON file with the function `convert_pcap_to_json()`.
- **convert_pcap_to_json(pcap_file, json_file)**:
  - Reads the pcap file using Scapy.
  - Converts each packet to a dictionary format.
  - Saves the packet information to a JSON file.

### `extract_attachments.py`
Extracts attachments from SMB2 WRITE and SMB2 READ packets and saves metadata with the function `extract_attachments()`.
- **extract_attachments(json_file, output_dir, metadata_file)**:
  - Loads packet data from the JSON file.
  - Checks for SMB2 WRITE and SMB2 READ commands.
  - Extracts and saves attachment data.
  - Collects metadata for each attachment.
  - Saves the metadata to a JSON file.

### `utils.py`
Contains utility functions used in `extract_attachments.py`.
- **is_base64(s)**:
  - Checks if a string is base64 encoded.
- **extract_timestamp_from_options(options)**:
  - Extracts a timestamp from TCP options and converts it to a human-readable format.

## Example
1. Run the script:
    ```sh
    python3 main.py example.pcap
    ```

2. Output:
    - `pcap_data.json`: Contains all packet details in JSON format.
    - `outputs/`: Contains extracted attachment files.
    - `metadata.json`: Contains metadata about the extracted attachments, including file name, file size, source IP, source port, destination IP, destination port, and timestamp.

## Troubleshooting
- Ensure you have all required libraries installed.
- Make sure the pcap file is in the correct format and contains SMB2 traffic.
- If you encounter encoding issues, check the format of the buffer data in the JSON file.


## License
This project is licensed under the MIT License - see the LICENSE file for details.

---
